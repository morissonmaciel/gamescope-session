#!/usr/bin/bash

# IMAGE_INFO="/usr/share/ublue-os/image-info.json"
# BASE_IMAGE_NAME=$(jq -r '."base-image-name"' < $IMAGE_INFO)
BASE_IMAGE_NAME="silverblue"

USER=$(id -nu 1000)
HOME=$(getent passwd $USER | cut -d: -f6)

# SteamOS autologin LIGHTDM config
AUTOLOGIN_CONF="/etc/lightdm/lightdm.conf.d/zz-steamos-autologin.conf"

if [[ $EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "$(realpath $0)" "$@"
fi

# Configure autologin if Steam has been updated
{
  echo "[Seat:*]"
  echo "autologin-session=gamescope-session"
} > "$AUTOLOGIN_CONF"

if [[ $BASE_IMAGE_NAME = "kinoite" ]]; then
    qdbus org.kde.Shutdown /Shutdown org.kde.Shutdown.logout
elif [[ $BASE_IMAGE_NAME = "silverblue" ]]; then
    gnome-session-quit --logout --no-prompt
fi

systemctl reset-failed xdm
systemctl restart xdm
